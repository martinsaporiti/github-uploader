<html>
    <head>
        <title>Github POC</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous"> -->
        <link rel="stylesheet" href="/static/bootstrap.min.css">
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script>
            $(function() {
                let CLIENT_ID = "ed8d53ef744372a8b9b0"
                let code = "";
                // let url = window.location.href;
                // var access_token = "";
                // const myArray = url.split("code=")
                // if (myArray.length > 1) {
                //     code = myArray[1];
                //     console.log(code);
                // }

                var params = new window.URLSearchParams(window.location.search);
                code = params.get('code');
                
                $('#loginBtn').click(function(){
                    $('#access_token').html("");
                    window.location.assign("https://github.com/login/oauth/authorize?client_id=" + CLIENT_ID +"&scope=repo,repo:status,public_repo,repo_deployment,user");
                })

                $('#getAccessTokenBtn').click(function(){
                    axios({
                        method: 'get',
                        url: 'http://localhost:9000/get_access_token?code=' + code,
                    })
                    .then(function (response) {
                        response = response.data;
                        access_token = response.access_token;
                        console.log("access token:", access_token)
                        $('#access_token').html(access_token);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });

                    // fetch('http://localhost:9000/get_access_token?code=' + code, {
                    //     method: 'GET',
                    //     headers: {
                    //         'Content-Type': 'application/json',
                    //     },
                    //     // body: JSON.stringify(data),
                    // })
                    // .then(response => response.json())
                    // .then(data => {
                    //     console.log('Success:', data);
                    //     access_token = data.access_token;
                    //     console.log("access token:", access_token)
                    //     $('#access_token').html(access_token);
                    // })
                    // .catch((error) => {
                    //     console.error('Error:', error);
                    //     swal("Error!", error, "error")
                    // });

                    // $.ajax({
                    //     url: 'https://github.com/login/oauth/access_token',
                    //     type: 'POST',
                    //     contentType: 'application/json',
                    //     data: JSON.stringify(data),
                    //     success: function(response) {
                    //         console.log(response)
                    //         swal("Good job!", message_response, "success")
                    //     },
                    //     error: function(error) {
                    //         console.log(error)
                    //         alert('Send Fail');
                    //     }
                    // })

                    // $.ajax({
                    //     url: 'http://localhost:9000/get_access_token?code=' + code,
                    //     type: 'GET',
                    //     contentType: 'application/json',
                    //     data: JSON.stringify(data),
                    //     success: function(response) {
                    //         access_token = response.access_token;
                    //         console.log("access token:", access_token)
                    //         $('#access_token').html(access_token);
                    //     },
                    //     error: function(error) {
                    //         console.log(error)
                    //     }
                    // })

                });


                // $('#publishSchemaBtn').click(function(){
                //     var data = JSON.stringify({
                //         "message": "txt file",
                //         "content": "c2NoZW1hIGJvZHk=",
                //         "author": {
                //             "name": "martinsaporiti",
                //             "email": "martinsaporiti@gmail.com"
                //         }
                //     });

                //     var b = "Bearer " + access_token; 
                //     console.log(b)
                //     $.ajax({
                //         url: 'https://api.github.com/repos/martinsaporiti/service_A/contents/abc7.txt',
                //         type: 'PUT',
                //         dataType: 'jsonp',
                //         headers: {
                //             'Authorization': b,
                //             "Content-Type": "application/json",
                //         //     'Accept' : '*/*',
                //         //     'X-GitHub-Api-Version': '2022-11-28',
                //         //     // 'Content-Type': 'application/json',
                //         //     'User-Agent': 'PostmanRuntime/7.32.2',
                //         //     'Connection' : 'keep-alive',
                //         },
                //         data: data,
                //         success: function(response) {
                //             access_token = JSON.stringify(response);
                //             console.log("response:", access_token)
                //         },
                //         error: function(error) {
                //             console.log(error)
                            
                //         }
                //     })
                // });


                // $('#publishSchemaBtn').click(function(){
                //     var b = `Bearer ${access_token}`
                //     console.log(b)
                //     var settings = {
                //         "url": "https://api.github.com/repos/martinsaporiti/service_A/contents/abc5.txt",
                //         "method": "PUT",
                //         "timeout": 0,
                //         "headers": {
                //             "Content-Type": "application/json",
                //             "Authorization": `Bearer ${access_token}`,
                //         },
                //         "data": JSON.stringify({
                //             "message": "txt file",
                //             "content": "c2NoZW1hIGJvZHk=",
                //             "author": {
                //                 "name": "martinsaporiti",
                //                 "email": "martinsaporiti@gmail.com"
                //             }
                //         }),
                //         dataType: 'jsonp',
                //         redirect: 'follow'
                //     };

                //     $.ajax(settings).done(function (response) {
                //         console.log(response);
                //     });

                // });

                $('#publishSchemaBtn').click(function(){
                    var myHeaders = new Headers();
                    var b = "Bearer " + access_token;  
                    console.log(b)
                    myHeaders.append("Content-Type", "application/json");
                    myHeaders.append("Authorization", b);

                    let c = $('#schemaContent').val();
                    console.log(c)
                    var encodedStringBtoA = btoa(c);
                    console.log(encodedStringBtoA)
                    var raw = JSON.stringify({
                        "message": "txt file",
                        "content": encodedStringBtoA,
                        "author": {
                            "name": "martinsaporiti",
                            "email": "martinsaporiti@gmail.com"
                        }
                    });

                    const config = {
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': b,
                        }
                    }
                    let f = $('#fileName').val();
                    let url  = 'https://api.github.com/repos/martinsaporiti/service_A/contents/' + f;
                    axios.put(url, raw, config)
                    .then(function (response) {
                        $('#result').html(JSON.stringify(response.data));
                    })
                    .catch(function (error) {
                        console.log(error);
                    });

                });
                //     var requestOptions = {
                //         method: 'PUT',
                //         headers: myHeaders,
                //         body: raw,
                //         redirect: 'follow',
                //         dataType: 'jsonp'
                //     };

                //     let f = $('#fileName').val();
                //     let path = "https://api.github.com/repos/martinsaporiti/service_A/contents/" + f;
                //     fetch(path, requestOptions)
                //     .then(response => response.text())
                //     .then(result => {
                //         console.log(result)
                //         $('#result').html(result);
                //     })
                //     .catch(error => console.log('error', error));

                // });

            });
        </script>
    </head>
    <body>
        <div class="container" style="margin-top: 30px; margin-bottom: 30px;">
            <div class="row mt-3">    
                <div class="col-md-2"></div>
                <div class="col-md-4">
                    <button class="btn btn-outline-primary" id="loginBtn">login</button>
                </div>
                <div class="col-md-6"></div>
            </div>
            <div class="row mt-3">    
                <div class="col-md-2"></div>
                <div class="col-md-4">
                    <button class="btn btn-outline-primary" id="getAccessTokenBtn">Get Access Token</button>
                </div>
                <div class="col-lg-6">
                    <p id="access_token"> </p>
                </div>
            </div>
            <div class="row mt-3">    
                <div class="col-md-2"></div>
                <div class="col-md-4">
                    <button class="btn btn-outline-primary" id="publishSchemaBtn">Publish Schema</button>
                </div>
                <div class="col-lg-6"></div>
            </div>
            <div class="row mt-3" >    
                <div class="col-md-2"></div>
                <div class="col-md-4">
                    <input type="text" class="form-control" id="fileName" placeholder="file name">
                </div>
                <div class="col-md-6"></div>
            </div>
            <div class="row mt-3" >    
                <div class="col-md-2"></div>
                <div class="col-md-4 form-group">
                    <textarea rows="13" class="form-control" id="schemaContent">
                    </textarea>    
                </div>
                <div class="col-md-6">
                    <p class="lead" id="result"> </p>
                </div>
            </div>
        </div>    
    </body>
</html>        